<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Security Certification Roadmap</title>
    <style>
        /* makes all elements include padding and borders in their width/height calculations */
        * {
            box-sizing: border-box;
        }
        
        /* Domain color variables - revised to match original design */
        :root {
            /* Colors from the original design - carefully checked against visual reference */
            --green: #70AD47;
            --greendk: #548235;
            --greenlt: #c3dbb8;  /* New light green for Network Security subdomains */
            --teal: #008080;
            --tealdk: #003F3E;
            --teallt: #8fc6c6;  /* New light teal for IAM subdomains */
            --orange: #fa8e36;
            --orangedk: #c06216;
            --orangelt: #fdeada;
            --yellow: #e4ac03;
            --yellowdk: #7F6000;
            --yellowlt: #f7e69e;  /* New light yellow for Asset Security subdomains */
            --black: #2a2a2a;
            --blackdk: #000000; 
            --blacklt: #d9d9d9;
            --purple: #683e9b;
            --purpledk: #352647;
            --purplelt: #eddbff;
            --skyblue: #6bb3f6;
            --skybluedk: #2665a0;
            --skybluelit: #b8e0ff;  /* New light sky blue for Development subdomains */
            --blue: #2e5688;
            --bluedk: #1f3147;
            --bluelt: #dce6f2;
            --red: #c0514d;
            --reddk: #8c3736;
            --redlt: #f2dcdb;
            --magenta: #830083;
            --magentadk: #490e49;
            
            /* Domain-specific variables */
            --net: var(--green);
            --netdk: var(--greendk);
            --netlt: var(--greenlt);
            --iam: var(--teal);
            --iamdk: var(--tealdk);
            --iamlt: var(--teallt);
            --eng: var(--orange);
            --engdk: var(--orangedk);
            --englt: var(--orangelt);
            --ast: var(--yellow);
            --astdk: var(--yellowdk);
            --astlt: var(--yellowlt);
            --rsk: var(--black);
            --rskdk: var(--blackdk);
            --rsklt: var(--blacklt);
            --tst: var(--purple);
            --tstdk: var(--purpledk);
            --tstlt: var(--purplelt);
            --dev: var(--skyblue);
            --devdk: var(--skybluedk);
            --devlt: var(--skybluelt);
            --ops: var(--red);
            --opsdk: var(--reddk);
            --opslt: var(--redlt);
            --opsblue: var(--blue);
            --opsbluedk: var(--bluedk);
            --opsbluelt: var(--bluelt);
        }

        body {
            font-family: "Segoe UI", "Calibri", Tahoma, "Geneva", Verdana, sans-serif;
            margin: 0;
            padding: 0;
        }

        #certmap-container {
            width: 100%;
            max-width: 100%;
            padding: 0 1vmax;
            box-sizing: border-box;
        }

        #certmap-container h1 {
            font-size: 2vmax;
            font-weight: 500;
            margin-bottom: 0.5vmax;
        }

        /* Toolbar styles */
        #certmap-toolbar {
            margin-top: 1vmax;
            margin-bottom: 1vmax;
            text-align: center;
        }

        .toolbar-button {
            padding: 0.5vmax 1vmax;
            font-size: 1vmax;
            margin-right: 1vmax;
            cursor: pointer;
            border: 1px solid #ccc;
            background-color: #f8f8f8;
            border-radius: 4px;
        }

        .toolbar-button:last-child {
            margin-right: 0;
        }

        .toolbar-button:hover {
            background-color: #eaeaea;
        }

        /* Filter container */
        .filter-container {
            margin-top: 1vmax;
            display: flex;
            justify-content: center;
            gap: 2vmax;
        }

        /* Hide candidate-only elements by default */
        .candidate-only {
            display: none;
        }

        /* Show them when in candidate view */
        body.candidate-view .candidate-only {
            display: inline-block;
        }

        /* Hide opacity mode button by default */
        #toggleOpacityMode {
            display: none;
        }

        /* Show it only when both candidate-view AND edit-mode are active */
        body.candidate-view.edit-mode #toggleOpacityMode {
            display: inline-block;
        }

        /* Certification grid styles - maintaining precise dimensions from original */
        .certchart {
            background: white;
            color: #323232;
            font-weight: 300;
            margin-top: 1vmax;
            display: block;
            width: 100%;
            position: relative;
            min-height: 47vmax; /* Increased to ensure full visibility */
        }

        /* Background grid with precise column specifications from original design */
        .certbg {
            background: #ffffff;
            display: grid;
            position: relative;
            /* Exact column measurements from original design */
            grid-template-columns: [skilllevel] 0.4vmax 
                                    [net] 7.5vmax 
                                    [iam] 2.65vmax
                                    [eng] 17.2vmax
                                    [ast] 5.1vmax
                                    [rsk] 21.8vmax
                                    [tst] 7.5vmax
                                    [dev] 2.7vmax
                                    [ops] 31.5vmax;
            grid-template-rows: [domain] 2vmax [chart] 43.7vmax;
            column-gap: 0.2vmax;
            white-space: pre-wrap;
            line-height: 130%;
            width: 100%;
        }

        /* Style for the domain titles */
        .domaintitle {
            font-weight: 450;
            font-size: 0.8vmax;
            text-align: center;
            align-self: center;
            width: 100%;
            margin-bottom: 0.5vmax;
            padding: 0 0.5vmax;
            grid-row: domain;
        }

        .subdomain-title {
            font-weight: 400;
            font-size: 0.5vmax;
            text-align: center;
            padding: 0.2vmax 0;
        }

        /* Skill level section styling - vertical labels */
        .skilllevelcontainer {
            grid-column: skilllevel;
            grid-row: chart;
            position: relative;
            height: 100%;
        }

        .skilllevelitem {
            transform: rotate(270deg);
            position: absolute;
            font-weight: 600;
            font-size: 0.9vmax;
            white-space: nowrap;
            transform-origin: left center;
        }

        /* Positioned skill level labels */
        .skilllevel-expert {
            top: 15%;
            left: 50%;
            color: var(--reddk);
        }

        .skilllevel-intermediate {
            top: 55%;
            left: 50%;
            color: var(--orangedk);
        }

        .skilllevel-beginner {
            top: 90%;
            left: 50%;
            color: var(--greendk);
        }

        /* Domain containers - specific styling for each domain */
        .networkcontainer, .iamcontainer, .engineercontainer, 
        .assetcontainer, .mgmtcontainer, .testingcontainer, 
        .softwarecontainer, .operationscontainer {
            display: grid;
            border-radius: 0.25vmax;
            grid-row: chart;
            height: 100%;
        }

        .networkcontainer { 
            border: 2px solid var(--green); 
            grid-column: net;
        }

        .iamcontainer { 
            border: 2px solid var(--teal); 
            grid-column: iam;
        }

        .engineercontainer { 
            border: 2px solid var(--orange);
            grid-column: eng;
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            grid-template-rows: auto;
            column-gap: 0.2vmax;
}

        .assetcontainer { 
            border: 2px solid var(--yellow); 
            grid-column: ast;
        }

        .mgmtcontainer { 
            border: 2px solid var(--black);
            grid-column: rsk;
            display: grid;
            grid-template-columns: repeat(9, 1fr);
            grid-template-rows: auto;
            column-gap: 0.2vmax;
        }

        .testingcontainer { 
            border: 2px solid var(--purple); 
            grid-column: tst;
        }

        .softwarecontainer { 
            border: 2px solid var(--skyblue); 
            grid-column: dev;
        }

        .operationscontainer { 
            border: 2px solid var(--red);
            grid-column: ops;
            display: grid;
            grid-template-columns: repeat(13, 1fr);
            grid-template-rows: auto;
            column-gap: 0.2vmax;
        }

            /* Subdomain styling */
            .subtitle1, .subtitle2, .subtitle3, .subtitle4, .subtitle5 {
                font-weight: 400;
                font-size: 0.7vmax;
                text-align: center;
                padding: 0.2vmax 0;
                grid-row: 1;
            }

            .subtitle1 {
                grid-column: span 1;
            }

            .subtitle2 {
                grid-column: span 2;
            }

            .subtitle3 {
                grid-column: span 3;
            }

            .subtitle4 {
                grid-column: span 4;
            }

            .subtitle5 {
                grid-column: span 5;
            }

        /* Engineer subdomain backgrounds */
        .subdomain-eng { 
            background: var(--orangelt);
            height: 100%;
        }

        /* Operations subdomain backgrounds */
        .subdomain-ops-blue { 
            background: var(--bluelt);
            height: 100%;
        }

        .subdomain-ops-red { 
            background: var(--redlt);
            height: 100%;
        }

        /* GRC subdomain background */
        .subdomain-rsk { 
            background: var(--blacklt);
            height: 100%;
        }

        /* Foreground grid for cert tiles - legacy grid specifications */
        .certcontainer {
            position: absolute;
            top: 4.8vmax; /* Adjusted to match legacy grid */
            left: -0.31vmax; /* Adjusted to match legacy grid */
            width: 100%;
            height: 43.7vmax;
            display: grid;
            grid-template-columns: [skilllevel] 1.7vmax [network] 2.3vmax 2.3vmax 2.3vmax .4vmax [iam] 2.3vmax .4vmax [engineer] 2.3vmax 2.3vmax 2.3vmax 2.3vmax 2.3vmax 2.3vmax 2.3vmax 0.4vmax [asset] 2.3vmax 2.3vmax 0.4vmax [mgmt] 2.3vmax 2.3vmax 2.3vmax 2.3vmax 2.3vmax 2.3vmax 2.3vmax 2.3vmax 2.3vmax 0.4vmax [testing] 2.3vmax 2.3vmax 2.3vmax 0.4vmax [software] 2.3vmax 0.4vmax [ops] 2.3vmax 2.3vmax 2.3vmax 2.3vmax 2.3vmax 2.3vmax 2.3vmax 2.3vmax 2.3vmax 2.3vmax 2.3vmax 2.3vmax 2.3vmax;
            grid-template-rows: repeat(27, 1.5vmax);
            column-gap: 0.1vmax;
            row-gap: 0.1vmax;
            pointer-events: none; /* Allow clicks to pass through to background */
        }

        /* Update certification tiles for grid placement */
        .certlink {
            background-color: var(--tileColor, #666);
            color: white;
            font-size: 0.7vmax;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.25vmax;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            cursor: pointer;
            z-index: 10;
            /* No absolute positioning needed */
        }


        

        /* Tooltip styles */
        [tooltiptext]:before {
            position: absolute;
            content: attr(tooltiptext);
            width: max-content;
            height: max-content;
            padding: 0.4vmax;
            background: inherit;
            border: inherit;
            border-radius: 0.2vmax;
            color: inherit;
            text-align: left;
            display: none;
            font-size: 125%;
        }
        
        [tooltiptext]:hover:before {
            display: block;    
        }
        
        [tooltiptexttitle]:before {
            position: absolute;
            content: attr(tooltiptexttitle);
            width: 25vmax;
            height: max-content;
            padding: 0.4vmax;
            background: var(--black);
            border: var(--blackdk);
            border-radius: 0.2vmax;
            color: white;
            text-align: left;
            display: none;
            font-size: 100%;
            z-index: 1;
            top: 4.5%;
        }
        
        [tooltiptexttitle]:hover:before {
            display: block;    
        }
        
        [tooltiptexttitleleft]:before {
            position: absolute;
            content: attr(tooltiptexttitleleft);
            width: 25vmax;
            height: max-content;
            padding: 0.4vmax;
            background: var(--black);
            border: var(--blackdk);
            border-radius: 0.2vmax;
            color: white;
            text-align: left;
            display: none;
            font-size: 100%;
            z-index: 1;
            top: 4.5%;
            left: 0%;
        }
        
        [tooltiptexttitleleft]:hover:before {
            display: block;    
        }

        /* Cert popup styles */
        .cert-popup-menu {
            position: absolute;
            background-color: white;
            border: 1px solid #888;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            padding: 10px;
            z-index: 9999;
            font-size: 16px;
            border-radius: 5px;
        }

        .cert-popup-menu button {
            display: block;
            width: 100%;
            margin: 0.2vmax 0;
            background: none;
            border: none;
            cursor: pointer;
            text-align: left;
            padding: 5px;
        }

        .cert-popup-menu button:hover {
            background-color: #f0f0f0;
        }

        /* Footer styles */
        .certmap-footer {
            text-align: right;
            color: #000000;
            padding: 0.2vmax;
            font-size: 1vmax;
            margin-top: 1vmax;
        }

        /* Responsive adjustments */
        @media screen and (max-width: 897px) {
            #interactive {display: none;}
            #static {display: block;}
        }

        /* Debug info panel */
        #debug-info {
            background: #f8f8f8;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            display: none;
        }
    </style>
</head>
<body>
        <div id="certmap-container">
        <div style="text-align:left;font-size:200%;font-weight:500;padding-bottom:0.2vmax;">Security Certification Roadmap</div>

        <!-- The main grid that will hold domains and certs -->
        <div id="certmap-grid">
            <!-- Empty placeholder - will be populated by JavaScript -->
        </div>
        
        <!-- Footer with info -->
        <div class="certmap-footer">
            <span id="cert-count">Loading certification data...</span>
        </div>
        <!-- Toolbar with filters and controls -->
        <div id="certmap-toolbar" class="cert-toolbar">
            <!-- Will be populated dynamically -->
            <button class="toolbar-button" id="toggleCandidateView">🎯 Candidate View</button>
            <button class="toolbar-button candidate-only" id="toggleEditMode">✏️ Edit My Certs</button>
            <button class="toolbar-button candidate-only" id="toggleOpacityMode">🌫 Transparent View</button>
            <button class="toolbar-button candidate-only" id="resetCertTracking">♻️ Clear Achieved & Planned</button>
            <br>
            
            <!-- Domain and Vendor filters -->
            <div class="filter-container candidate-only">
                <label for="domainGroupFilter" style="font-size: 1vmax;">
                    🔍 Domain:
                    <select id="domainGroupFilter" style="font-size: 1vmax; margin-left: 0.5vmax;">
                        <option value="ALL">All Domains</option>
                        <!-- Will be populated from domains.json -->
                    </select>
                </label>
                
                <label for="vendorFilter" style="font-size: 1vmax;">
                    🏷️ Vendor:
                    <select id="vendorFilter" style="font-size: 1vmax; margin-left: 0.5vmax;">
                        <option value="ALL">All Vendors</option>
                        <!-- Will be populated from certs.json -->
                    </select>
                </label>
            </div>
        </div>
    </div>

    <!-- Script to load and initialize the certification map -->
    <script>
    // Initialize CertMap object FIRST before any event handlers are set up
    window.CertMap = {};
    
    // Configuration module for the Certification Roadmap
    CertMap.config = {
        dataPath: {
            domains: 'data/domains.json',
            subdomains: 'data/subdomains.json',
            certs: 'data/certs.json'  // Not created yet but will be needed
        },
        viewModes: {
            default: 'default',
            candidate: 'candidate-view'
        },
        storageKeys: {
            achievedCerts: 'achievedCerts',
            plannedCerts: 'plannedCerts',
            transparentView: 'transparentView'
        }
    };

    // Data storage
    CertMap.data = {
        domains: [],
        subdomains: [],
        certs: [],
        // State management
        state: {
            currentView: CertMap.config.viewModes.default,
            editMode: false,
            filters: {
                domain: 'ALL',
                vendor: 'ALL'
            }
        }
    };

    // Function to load domain data from JSON files
    CertMap.loadData = async function() {
        try {
            // Load domains data
            console.log('Fetching domains from:', CertMap.config.dataPath.domains);
            const domainsResponse = await fetch(CertMap.config.dataPath.domains);
            if (!domainsResponse.ok) {
                throw new Error(`Failed to fetch domains: ${domainsResponse.status} ${domainsResponse.statusText}`);
            }
            CertMap.data.domains = await domainsResponse.json();
            console.log('Loaded domains:', CertMap.data.domains.length);
            
            // Debug domain details
            CertMap.data.domains.forEach(domain => {
                console.log(`Domain: ${domain.id}, Name: ${domain.name}, Order: ${domain.order}`);
            });
            
            // Load subdomains data
            console.log('Fetching subdomains from:', CertMap.config.dataPath.subdomains);
            const subdomainsResponse = await fetch(CertMap.config.dataPath.subdomains);
            if (!subdomainsResponse.ok) {
                throw new Error(`Failed to fetch subdomains: ${subdomainsResponse.status} ${subdomainsResponse.statusText}`);
            }
            CertMap.data.subdomains = await subdomainsResponse.json();
            console.log('Loaded subdomains:', CertMap.data.subdomains.length);

            // Load certification data
            console.log('Fetching certifications from:', CertMap.config.dataPath.certs);
            const certsResponse = await fetch(CertMap.config.dataPath.certs);
            if (!certsResponse.ok) {
                throw new Error(`Failed to fetch certifications: ${certsResponse.status} ${certsResponse.statusText}`);
            }
            CertMap.data.certs = await certsResponse.json();
            console.log('Loaded certifications:', CertMap.data.certs.length);
            
            console.log('All data loaded successfully');
            return true;
        } catch (error) {
            console.error('Error loading data:', error);
            return false;
        }
    };

    // Renderer module for the Certification Roadmap
    CertMap.renderer = {
        // Add to the CertMap.renderer object
        createCertificationTiles: function() {
        console.log('Creating certification tiles...');
        const container = document.querySelector('.certcontainer');
        if (!container) {
            console.error('Certification container not found');
            return false;
        }
        
        // Clear any existing certification tiles
        container.innerHTML = '';
        
        // Get all certifications
        const certs = CertMap.data.certs;
        if (!certs || !certs.length) {
            console.warn('No certification data available');
            return false;
        }
        
        console.log(`Processing ${certs.length} certification tiles`);
        
        // Group certifications by domain and skill strata
        const groupedCerts = this.groupCertificationsByDomainAndStrata(certs);
        
        // Create a tile for each certification in the sorted order
        for (const domainId in groupedCerts) {
            for (const strata in groupedCerts[domainId]) {
                // Sort certifications within the same domain and strata alphabetically by ID
                const domainStrataCerts = groupedCerts[domainId][strata];
                domainStrataCerts.sort((a, b) => a.id.localeCompare(b.id));
                
                // Position each certification in the group
                domainStrataCerts.forEach((cert, index) => {
                    // Create the certification tile
                    const certTile = document.createElement('a');
                    certTile.className = 'certlink';
                    certTile.href = cert.certUrl || '#';
                    certTile.target = '_blank';
                    certTile.rel = 'noopener';
                    certTile.setAttribute('data-cert-id', cert.id);
                    
                    // Position the tile using the calculated position
                    this.positionCertTile(certTile, cert, index, domainStrataCerts.length);
                    
                    // Set the color based on domain and team role
                    this.setTileColor(certTile, cert);
                    
                    // Set the content
                    certTile.textContent = cert.label;
                    
                    // Add tooltip with detailed info
                    certTile.setAttribute('tooltiptext', cert.tooltip);
                    
                    // Add the tile to the container
                    container.appendChild(certTile);
                });
            }
        }
        
        // Update cert count
        const countElement = document.getElementById('cert-count');
        if (countElement) {
            const date = new Date();
            const monthYear = date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            countElement.textContent = `${certs.length} certifications loaded | ${monthYear}`;
        }
        
        return true;
    },

        groupCertificationsByDomainAndStrata: function(certs) {
        console.log('Grouping certifications by domain and skill strata');
        const groupedCerts = {};
        
        // First, group by domain and skill strata
        certs.forEach(cert => {
            const domain = cert.domain;
            const strata = cert.skillStrata;
            
            // Initialize domain object if it doesn't exist
            if (!groupedCerts[domain]) {
                groupedCerts[domain] = {};
            }
            
            // Initialize strata array if it doesn't exist
            if (!groupedCerts[domain][strata]) {
                groupedCerts[domain][strata] = [];
            }
            
            // Add cert to its domain and strata group
            groupedCerts[domain][strata].push(cert);
        });
        
        console.log('Certification grouping complete');
        return groupedCerts;
    },

        // Helper for grid positioning - calculates grid position for certification tiles
        getGridPosition: function(cert, indexInGroup, totalInGroup) {
            // Domain column mapping (where each domain starts in the grid)
            const domainColumns = {
                'NET': 2,
                'IAM': 6,
                'ENG': 8,
                'AST': 16,
                'RSK': 19,
                'TST': 29,
                'DEV': 33,
                'OPS': 35
            };
            
            // Domain column spans (how many columns each domain occupies)
            const domainSpans = {
                'NET': 3,
                'IAM': 1,
                'ENG': 7,
                'AST': 2,
                'RSK': 9,
                'TST': 3,
                'DEV': 1,
                'OPS': 13
            };
            
            // Skill level row ranges (where each skill level starts and ends)
            const skillRows = {
                3: { start: 3, end: 9 },   // Expert
                2: { start: 12, end: 18 }, // Intermediate
                1: { start: 21, end: 27 }  // Beginner
            };
            
            // Get domain data
            const colStart = domainColumns[cert.domain] || 2;
            const colSpan = domainSpans[cert.domain] || 1;
            
            // Get skill level row range
            const rowRange = skillRows[cert.skillStrata] || skillRows[1];
            
            // Calculate column position within domain area
            let colPos;
            if (totalInGroup <= colSpan) {
                // If we have fewer certs than columns, space them evenly
                colPos = colStart + Math.floor(indexInGroup * (colSpan / totalInGroup));
            } else {
                // If we have more certs than columns, distribute them
                const rowsNeeded = Math.ceil(totalInGroup / colSpan);
                const rowIndex = Math.floor(indexInGroup / colSpan);
                colPos = colStart + (indexInGroup % colSpan);
                
                // Adjust row based on distribution
                const rowPos = rowRange.start + rowIndex;
                return { 
                    column: colPos, 
                    row: rowPos < rowRange.end ? rowPos : rowRange.end - 1 
                };
            }
            
            // Return position with row distribution
            return { 
                column: colPos, 
                row: rowRange.start + (indexInGroup % (rowRange.end - rowRange.start)) 
            };
        },

        positionCertTile: function(tileElement, cert, indexInGroup, totalInGroup) {
        // Calculate grid position using our helper method
        const position = this.getGridPosition(cert, indexInGroup, totalInGroup);
        
        // Set the color based on domain and team role
        this.setTileColor(tileElement, cert);
        
        // Find the corresponding domain
        const domain = CertMap.data.domains.find(d => d.id === cert.domain);
        if (!domain) {
            console.error(`Domain not found for certification: ${cert.id}`);
            return;
        }
        
        // Apply grid positioning
        tileElement.style.gridColumn = position.column;
        tileElement.style.gridRow = position.row;
        
        // Set standard dimensions for certification tiles
        tileElement.style.width = "2.3vmax";
        tileElement.style.height = "1.5vmax";
        
        // Add data attributes for filtering
        tileElement.setAttribute('data-domain', cert.domain);
        tileElement.setAttribute('data-skill-strata', cert.skillStrata);
        tileElement.setAttribute('data-vendor', cert.vendor);
        tileElement.setAttribute('data-grid-col', position.column);
        tileElement.setAttribute('data-grid-row', position.row);
        
        if (cert.subdomain) {
            tileElement.setAttribute('data-subdomain', cert.subdomain);
        }
        if (cert.teamRole) {
            tileElement.setAttribute('data-team-role', cert.teamRole);
        }
    },
    },

            // Set the color of the certification tile based on domain and team role
            setTileColor: function(tileElement, cert) {
                // Find the corresponding domain
                const domain = CertMap.data.domains.find(d => d.id === cert.domain);
                if (!domain) {
                    console.error(`Domain not found for certification: ${cert.id}`);
                    return;
                }
                
                // Determine the team role
                const teamRole = cert.teamRole || 'DefaultTeam';
                
                // Set the background color based on domain and team role
                if (domain.teamRoles && domain.teamRoles[teamRole]) {
                    tileElement.style.backgroundColor = domain.teamRoles[teamRole].tileColor;
                    tileElement.style.border = `1px solid ${domain.teamRoles[teamRole].borderColor}`;
                } else {
                    // Fallback to domain default color
                    tileElement.style.backgroundColor = domain.teamRoles.DefaultTeam.tileColor;
                    tileElement.style.border = `1px solid ${domain.teamRoles.DefaultTeam.borderColor}`;
                }
            },
        
        // Main render function
        renderCertMap: function() {
            console.log('Rendering certification map...');
            const container = document.getElementById('certmap-grid');
            if (!container) {
                console.error('Grid container not found');
                this.createCertificationTiles();
                return false;
            }
            
            // Clear previous content
            container.innerHTML = '';
            
            // Add main chart container
            const chartContainer = document.createElement('div');
            chartContainer.className = 'certchart';
            
            // Create background grid (domains and subdomains)
            const bgGrid = this.createBackgroundGrid();
            chartContainer.appendChild(bgGrid);
            
            // Create foreground grid (cert tiles will go here)
            const fgGrid = this.createForegroundGrid();
            chartContainer.appendChild(fgGrid);
            
            // Add the completed grid to the container
            container.appendChild(chartContainer);
            
            // Update cert count
            const countElement = document.getElementById('cert-count');
            if (countElement) {
                const date = new Date();
                const monthYear = date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                countElement.textContent = `${CertMap.data.domains.length} domains loaded | ${monthYear}`;
            }
            this.createCertificationTiles();
            return true;
        },
        
        // Create the background grid with domains and subdomains
        createBackgroundGrid: function() {
            const bgGrid = document.createElement('div');
            bgGrid.className = 'certbg';
            
            // Create domain header row
            this.createDomainHeaders(bgGrid);
            
            // Create skill level indicators
            this.createSkillLevels(bgGrid);
            
            // Create domain containers
            this.createDomainContainers(bgGrid);
            
            return bgGrid;
        },
        
        // Create skill level indicators
        createSkillLevels: function(bgGrid) {
            const skillLevelContainer = document.createElement('div');
            skillLevelContainer.className = 'skilllevelcontainer';
            
            // Define skill levels
            const skillLevels = [
                { name: 'Expert', class: 'skilllevel-expert' },
                { name: 'Intermediate', class: 'skilllevel-intermediate' },
                { name: 'Beginner', class: 'skilllevel-beginner' }
            ];
            
            // Create skill level labels
            skillLevels.forEach(level => {
                const levelLabel = document.createElement('div');
                levelLabel.className = `skilllevelitem ${level.class}`;
                levelLabel.textContent = level.name;
                skillLevelContainer.appendChild(levelLabel);
            });
            
            bgGrid.appendChild(skillLevelContainer);
        },
        
        // Create domain header titles
        createDomainHeaders: function(bgGrid) {
            // Sort domains by order
            const sortedDomains = [...CertMap.data.domains].sort((a, b) => a.order - b.order);
            
            // Create a header for each domain
            sortedDomains.forEach(domain => {
                const domainTitle = document.createElement('div');
                domainTitle.className = 'domaintitle';
                domainTitle.style.color = `var(--${domain.id.toLowerCase()})`;
                domainTitle.style.gridColumn = domain.id.toLowerCase();
                domainTitle.textContent = domain.name;
                domainTitle.style.width = '100%'; 
                domainTitle.style.textAlign = 'center';
                domainTitle.style.display = 'block'; // Removes flexbox
                
                // Add tooltip with domain description
                if (domain.description) {
                    // Determine tooltip positioning (left-aligned for domains on the left side)
                    const tooltipAttr = domain.order <= 4 ? 'tooltiptexttitleleft' : 'tooltiptexttitle';
                    domainTitle.setAttribute(tooltipAttr, domain.description);
                }
                
                bgGrid.appendChild(domainTitle);
            });
        },
        
        // Create containers for each domain
        createDomainContainers: function(bgGrid) {
            // Sort domains by order
            const sortedDomains = [...CertMap.data.domains].sort((a, b) => a.order - b.order);
            
            // Create a container for each domain
            sortedDomains.forEach(domain => {
                // Determine container class based on domain ID
                const containerClass = this.getDomainContainerClass(domain.id);
                
                const domainContainer = document.createElement('div');
                domainContainer.className = containerClass;
                domainContainer.setAttribute('data-domain-id', domain.id);
                
                // Get subdomains for this domain
                const domainSubdomains = CertMap.data.subdomains.filter(
                    subdomain => subdomain.domainId === domain.id
                );
                
                // Create subdomain sections if any exist
                if (domainSubdomains.length > 0) {
                    // Group subdomains by teamRole for columnar layout
                    const groupedSubdomains = this.groupSubdomainsByTeamRole(domainSubdomains);
                    
                    // Create subdomain columns
                    this.createSubdomainColumns(domainContainer, groupedSubdomains, domain);
                }
                
                bgGrid.appendChild(domainContainer);
                console.log(`Created container for domain ${domain.id} with class ${containerClass}`);
            });
        },
        
        // Group subdomains by teamRole for columnar display
        groupSubdomainsByTeamRole: function(subdomains) {
            const groups = {};
            
            subdomains.forEach(subdomain => {
                const role = subdomain.teamRole || 'DefaultTeam';
                if (!groups[role]) {
                    groups[role] = [];
                }
                groups[role].push(subdomain);
            });
            
            return groups;
        },
        
        // Create columns for each subdomain group
        createSubdomainColumns: function(domainContainer, groupedSubdomains, domain) {
        const domainId = domain.id;
        
        // Instead of absolute positioning, use CSS Grid for layout
        domainContainer.style.display = 'grid';
        
        // Define how many columns each domain has for subdomains
        const domainColumnCounts = {
            'ENG': 7,
            'RSK': 9,
            'OPS': 13
        };
        
        // Set up grid columns if this domain has a defined count
        if (domainColumnCounts[domainId]) {
            domainContainer.style.gridTemplateColumns = `repeat(${domainColumnCounts[domainId]}, 1fr)`;
            domainContainer.style.gridTemplateRows = 'auto 1fr'; // Header row and content
        }
        
        // Define subdomain spans
        const subdomainSpans = {
            'ENG': {
                'ENG_cloudSysOps': { start: 1, span: 4 },
                'ENG_nix': { start: 5, span: 1 },
                'ENG_icsiot': { start: 6, span: 1 }
            },
            'RSK': {
                'RSK_grc': { start: 4, span: 4 }
            },
            'OPS': {
                'OPS_forensics': { start: 3, span: 2 },
                'OPS_incidentHandling': { start: 5, span: 2 },
                'OPS_penTesting': { start: 7, span: 5 },
                'OPS_exploitation': { start: 12, span: 2 }
            }
        };
        
        // Handle each subdomain separately to create columns
        Object.entries(groupedSubdomains).forEach(([teamRole, subdomains]) => {
            subdomains.forEach(subdomain => {
                const position = subdomainSpans[domainId]?.[subdomain.id];
                if (!position) return;
                
                // Create subdomain column container
                const columnContainer = document.createElement('div');
                
                // Determine background class based on team role and domain
                let backgroundClass = '';
                
                if (teamRole === 'RedTeam' && domainId === 'OPS') {
                    backgroundClass = 'subdomain-ops-red';
                    columnContainer.style.backgroundColor = 'var(--redlt)';
                } else if (teamRole === 'BlueTeam' && domainId === 'OPS') {
                    backgroundClass = 'subdomain-ops-blue';
                    columnContainer.style.backgroundColor = 'var(--bluelt)';
                } else if (domainId === 'ENG') {
                    backgroundClass = 'subdomain-eng';
                    columnContainer.style.backgroundColor = 'var(--orangelt)';
                } else if (domainId === 'RSK') {
                    backgroundClass = 'subdomain-rsk';
                    columnContainer.style.backgroundColor = 'var(--blacklt)';
                }
                
                columnContainer.className = backgroundClass;
                columnContainer.setAttribute('data-subdomain-id', subdomain.id);
                columnContainer.style.gridRow = '2'; // Place in the content row
                columnContainer.style.gridColumn = `${position.start} / span ${position.span}`;
                columnContainer.style.height = '100%';
                
                // Add subdomain header
                const titleElement = document.createElement('div');
                titleElement.className = 'subdomain-title';
                titleElement.textContent = subdomain.name;
                columnContainer.appendChild(titleElement);
                
                // Add to domain container
                domainContainer.appendChild(columnContainer);
            });
        });
        
    },
        
        // Create the foreground grid for cert tiles
        createForegroundGrid: function() {
            const fgGrid = document.createElement('div');
            fgGrid.className = 'certcontainer';
            
            // This will later contain certification tiles
            // For now, it's just an empty grid that overlays the background
            
            return fgGrid;
        },
        
        // Helper to get the container class based on domain ID
        getDomainContainerClass: function(domainId) {
            const domainMap = {
                'NET': 'networkcontainer',
                'IAM': 'iamcontainer',
                'ENG': 'engineercontainer',
                'AST': 'assetcontainer',
                'RSK': 'mgmtcontainer',
                'TST': 'testingcontainer',
                'DEV': 'softwarecontainer',
                'OPS': 'operationscontainer'
            };
            
            return domainMap[domainId] || `${domainId.toLowerCase()}container`;
        }
    };

    // Add a debugging function to help identify issues
    CertMap.debug = function() {
        console.log('CertMap Debug Info:');
        console.log('- Domains loaded:', this.data.domains ? this.data.domains.length : 0);
        console.log('- Subdomains loaded:', this.data.subdomains ? this.data.subdomains.length : 0);
        console.log('- Grid container exists:', !!document.getElementById('certmap-grid'));
        
        // Display debug info in the debug-info panel
        const debugMessages = document.getElementById('debug-messages');
        if (debugMessages) {
            debugMessages.innerHTML = `
                <p><strong>Domains loaded:</strong> ${this.data.domains ? this.data.domains.length : 0}</p>
                <p><strong>Subdomains loaded:</strong> ${this.data.subdomains ? this.data.subdomains.length : 0}</p>
                <p><strong>Grid container exists:</strong> ${!!document.getElementById('certmap-grid')}</p>
                <p><strong>Current View Mode:</strong> ${this.data.state.currentView}</p>
            `;
            
            // Add domain names if loaded
            if (this.data.domains && this.data.domains.length > 0) {
                debugMessages.innerHTML += `<p><strong>Domain IDs:</strong> ${this.data.domains.map(d => d.id).join(', ')}</p>`;
            }
        }
    };

    // Add a simple test function to display domain names
    CertMap.testDomainsDisplay = function() {
        console.log('Testing domain display...');
        
        // Get a container to show our test output
        const container = document.getElementById('certmap-grid');
        if (!container) {
            console.error('Grid container not found');
            return;
        }
        
        // Clear any existing content
        container.innerHTML = '';
        
        // Create a simple list of domains
        const list = document.createElement('ul');
        list.style.listStyle = 'none';
        list.style.padding = '1vmax';
        
        // Add each domain as a list item
        CertMap.data.domains.forEach(domain => {
            const item = document.createElement('li');
            item.textContent = `${domain.id}: ${domain.name}`;
            item.style.color = domain.teamRoles.DefaultTeam.tileColor;
            item.style.fontWeight = 'bold';
            item.style.padding = '0.5vmax';
            item.style.marginBottom = '0.5vmax';
            item.style.borderLeft = `4px solid ${domain.teamRoles.DefaultTeam.tileColor}`;
            list.appendChild(item);
            
            // Add subdomains for this domain
            const subdomains = CertMap.data.subdomains.filter(
                subdomain => subdomain.domainId === domain.id
            );
            
            if (subdomains.length > 0) {
                const subList = document.createElement('ul');
                subList.style.listStyle = 'none';
                subList.style.paddingLeft = '2vmax';
                
                subdomains.forEach(subdomain => {
                    const subItem = document.createElement('li');
                    subItem.textContent = subdomain.name;
                    subItem.style.color = '#444';
                    subItem.style.padding = '0.3vmax';
                    subList.appendChild(subItem);
                });
                
                list.appendChild(subList);
            }
        });
        
        // Add the list to the container
        container.appendChild(list);
        
        // Update cert count in footer
        const countElement = document.getElementById('cert-count');
        if (countElement) {
            countElement.textContent = `${CertMap.data.domains.length} domains, ${CertMap.data.subdomains.length} subdomains loaded | Test Mode`;
        }

    };

    // Improved initialization function with error handling
    CertMap.init = async function() {
        console.log('Initializing CertMap...');
        
        try {
            // Load data first
            const dataLoaded = await this.loadData();
            if (!dataLoaded) {
                console.error('Failed to load certification data');
                document.getElementById('certmap-grid').innerHTML = '<div style="color:red;padding:20px;">Failed to load certification data. Please check console for errors.</div>';
                return;
            }
            
            console.log('Data loaded successfully');
            
            // Render the certification map
            const renderSuccess = this.renderer.renderCertMap();
            if (!renderSuccess) {
                console.error('Failed to render certification map');
                document.getElementById('certmap-grid').innerHTML = '<div style="color:red;padding:20px;">Failed to render certification map. Check console for errors.</div>';
                return;
            }
            
            console.log('CertMap initialization completed successfully');
        } catch (error) {
            console.error('Error during CertMap initialization:', error);
            const gridContainer = document.getElementById('certmap-grid');
            if (gridContainer) {
                gridContainer.innerHTML = `<div style="color:red;padding:20px;">Error: ${error.message}</div>`;
            }
        }
    };

    // Properly attach event listeners AFTER defining all methods
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize the certification map
        CertMap.init();
        
    });
    </script>
</body>
</html>